name: Build and Deploy

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.configure.outputs.deployment_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Configure deployment paths
        id: configure
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          BRANCH_NAME="${GITHUB_REF_NAME}"
          SHORT_SHA="$(git rev-parse --short HEAD)"
          BUILD_TIMESTAMP="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          BRANCH_SLUG="$(echo "${BRANCH_NAME}" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-+|-+$//g')"

          if [ -z "${BRANCH_SLUG}" ]; then
            BRANCH_SLUG="preview"
          fi

          if [ "${BRANCH_NAME}" = "main" ]; then
            echo "BASE_PATH=/${REPO_NAME}" >> "${GITHUB_ENV}"
            echo "OUTPUT_SUBDIR=" >> "${GITHUB_ENV}"
            PAGE_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}"
          else
            echo "BASE_PATH=/${REPO_NAME}/${BRANCH_SLUG}" >> "${GITHUB_ENV}"
            echo "OUTPUT_SUBDIR=${BRANCH_SLUG}" >> "${GITHUB_ENV}"
            PAGE_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}/${BRANCH_SLUG}"
          fi

          echo "BRANCH_SLUG=${BRANCH_SLUG}" >> "${GITHUB_ENV}"
          echo "VITE_GITHUB_BRANCH=${BRANCH_NAME}" >> "${GITHUB_ENV}"
          echo "VITE_GITHUB_REPOSITORY=${REPO_OWNER}/${REPO_NAME}" >> "${GITHUB_ENV}"
          echo "VITE_BUILD_SHA=${SHORT_SHA}" >> "${GITHUB_ENV}"
          echo "VITE_BUILD_BRANCH=${BRANCH_NAME}" >> "${GITHUB_ENV}"
          echo "VITE_BUILD_TIMESTAMP=${BUILD_TIMESTAMP}" >> "${GITHUB_ENV}"
          echo "DEPLOYMENT_URL=${PAGE_URL}" >> "${GITHUB_ENV}"
          echo "deployment_url=${PAGE_URL}" >> "${GITHUB_OUTPUT}"

      - name: Install dependencies
        run: npm install

      - name: Lint
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

      - name: Type check
        run: npm run check

      - name: Build
        run: npm run build
        env:
          BASE_PATH: ${{ env.BASE_PATH }}
          VITE_GITHUB_BRANCH: ${{ env.VITE_GITHUB_BRANCH }}
          VITE_GITHUB_REPOSITORY: ${{ env.VITE_GITHUB_REPOSITORY }}
          VITE_BUILD_SHA: ${{ env.VITE_BUILD_SHA }}
          VITE_BUILD_BRANCH: ${{ env.VITE_BUILD_BRANCH }}
          VITE_BUILD_TIMESTAMP: ${{ env.VITE_BUILD_TIMESTAMP }}

      - name: Scope preview artifact to branch path
        if: env.OUTPUT_SUBDIR != ''
        run: |
          mv build build-root
          mkdir -p build/${OUTPUT_SUBDIR}
          cp -a build-root/. build/${OUTPUT_SUBDIR}/
          rm -rf build-root

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build

  deploy:
    needs: build
    environment:
      name: github-pages
      url: ${{ needs.build.outputs.deployment_url }}
    runs-on: ubuntu-latest
    env:
      DEPLOYMENT_URL: ${{ needs.build.outputs.deployment_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Share preview URL on pull request
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const marker = '<!-- preview-url -->';
            const branch = process.env.GITHUB_REF_NAME;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const { data: pullRequests } = await github.rest.pulls.list({
              owner,
              repo,
              head: `${owner}:${branch}`,
              state: 'open',
            });

            if (!pullRequests.length) {
              core.info(`No open pull requests found for branch ${branch}.`);
              return;
            }

            const body = `${marker}\nðŸš€ Preview available at: ${process.env.DEPLOYMENT_URL}`;

            for (const pr of pullRequests) {
              const { data: comments } = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: pr.number,
              });

              const existing = comments.find((comment) =>
                comment.user?.type === 'Bot' && comment.body?.includes(marker)
              );

              if (existing) {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: existing.id,
                  body,
                });
                core.info(`Updated preview comment on PR #${pr.number}.`);
              } else {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body,
                });
                core.info(`Created preview comment on PR #${pr.number}.`);
              }
            }
